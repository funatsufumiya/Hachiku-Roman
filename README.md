# Hachiku - Windows で薙刀式を使うスクリプト
2022年9月1日付[【薙刀式】15B102（最新）](http://oookaworks.seesaa.net/article/491147874.html#gsc.tab=0)
の薙刀式v15（仮）B102 を Autohotkey に実装しました。

---
パソコンの日本語キーボード、英語キーボードの設定に自動で合わせます。  
トレイアイコンを右クリックしたところに、縦書き・横書きモード切り替え、設定メニューがあります。  
レジストリの変更はしません。  
不要になったら Hachiku.exe と Hachiku.ini を削除してください。

__以前からお使いの方も、一度 IME の設定を見直してみてください。__  
キーカスタマイズができる IME では、「Shift+Ctrl+変換キー」に「全確定」を割り当てることで動作を改善しています。
## 実行ファイル
https://github.com/tor-nky/Hachiku/releases
## ソースコードを修正した場合
ディレクトリ source の下にあるファイルをすべて保存します。  
Autohotkey をインストールし、ディレクトリ src にある Hachiku.ahk のスクリプトを実行してください。
# IME の設定
Hachiku のトレイアイコンを右クリックして設定を選び、IMEを選択します。

そしてIMEに対する設定を行ってください。
### 旧MS-IME
初期状態の設定のままでも使えますが、次の設定を行うことをおすすめします。  
（{確定}する際に選択範囲を消してしまうことがなくなります）

Microsoft IME の設定 → IME 入力モード切替の通知 → __オフ__: 画面中央に表示する

(キー設定をユーザー定義にしている場合)  
Microsoft IME の設定 → 詳細設定(A) → キー設定(Y)
|* キー         |入力/変換済み文字なし|入力文字のみ|変換済み    |候補一覧表示中|文節長変更中|変換済み文節内入力文字|
|---------------|:-------------------:|:----------:|:----------:|:------------:|:----------:|:--------------------:|
|半角/全角      |IME-オン/オフ        |__半英固定__|__半英固定__|__半英固定__  |__半英固定__|__半英固定__          |
|Ctrl+Shift+変換|      -              |__全確定__  |__全確定__  |__全確定__    |__全確定__  |__全確定__            |

Ctrl+Shift+変換 は Ctrl+Enter を選択してキー追加すると簡単です。
### 新MS-IME
初期状態の設定で使います。
### ATOK
いくつかの設定と、キーカスタマイズが必要です。

ATOK プロパティ → 入力･変換 → 設定項目(Y) → 入力補助 → 特殊 → 設定一覧(L)
   - __なし__: 日本語入力オンで変更したモードを元に戻す

ATOK プロパティ → キー･ローマ字･色 → キーカスタマイズ(K)
|キー             |機能                                                                        |
|-----------------|----------------------------------------------------------------------------|
|変換             |[_文字未入力_]__再変換__                                                    |
|Shift+Ctrl+変換  |__Enter と同じ__                                                            |
|半角／全角       |[_文字未入力_][_記号入力_]日本語入力ON/OFF [_他_]__入力文字種半角無変換(A)__|
### Google 日本語入力
キー設定を行ってください
|モード      |入力キー         |コマンド          |
|------------|:---------------:|:----------------:|
|変換前入力中|Ctrl Shift Henkan|       確定       |
|変換中      |      〃         |        〃        |
|変換前入力中|Shift Muhenkan   |全角英数に入力切替|
|変換中      |      〃         |        〃        |
|入力文字なし|      〃         |        〃        |
# 独自機能
* 方向キー、BS、Del を割り当てたキーにはリピートが働きます。
* Q+W に横書きモード、Q+A に縦書きモード を割り当て
* 編集モードD+F+H、J+K+G、J+K+V、J+K+Bは変換中かどうかを問いません。
* 編集モードM+Comma+W、M+Comma+S、M+Comma+F、M+Cooma+B (後からカッコ付け)の後、クリップボードは空になります。
* 固有名詞ショートカットにシフト面（スペース押下）も設定できます。  
スペースキーを押したまま、そこから3つのキーを素早く押すと入力されます。
* 固有名詞ショートカットを最大５組切り替えられる。  
切り替えは E+R+1 で１番、E+R+2 で２番、など。  
「固有名詞登録」画面が出ているときに切り替えると、登録内容がコピーされます。
(OK を押すと登録されます)
* スペースキーにリピートを設定できる  
リピートで漢字変換が始まっても、文字キーを押せば変換を取り消して文字が入力されます。
* 左右の小指シフトの機能を「英数」・「かな」から選べる
* 「後置シフト」を設定可能
* CapsLock がオンでも配列変換する
オリジナルの DvorakJ版では、CapsLock をオンにすると薙刀式になりません。
## 仕様
* かな入力中にアプリケーションのメニューをキーボードで操作できない  
英数入力に切り替えてください
* 記号入力、固有名詞ショートカットで不要な＿（アンダースコア）が入力されている。  
記号を入力する際に、＿（アンダースコア）→エンター→前文字削除 を送ることがあり、「元に戻す」と ＿（アンダースコア）が見えることがあります。

IME の設定を見直すのも良いかもしれません。
# 不具合
* 「名前を付けて保存」で IMEオフの状態だと、2文字目以降に大文字を入力してから何も入力ができない
秀丸エディタのみの現象です
* 入力したはずのキーがごくまれに無視される  
~~AutoHotkey の 64ビット版で起きやすいんですが、32ビット版でも起きることがあります。~~
* 薙刀式に変換が正しく行われないことがある  
新MS-IME(Win10 2004以降の標準)ではよく「かな」が英字に化けます。
2022年9月1日現在

|バージョン   |新MS-IME誤変換頻度            |
--------------|-------------------------------
|Windows 10 用|日本語変換後300～1000字に1回程|
|Windows 11 用|日本語変換後20～300字に1回程  |
* IMEの設定変更をしなければ、編集モードや固有名詞の入力でIME 入力モード切替の通知が出る。  
一部の記号を出力するために一旦、IMEをオフにしているためです。  
IMEに対する設定をご確認ください。
* (新MS-IME) かな変換中に英数入力に切り替え、確定しないでキーを押すと最初の文字が入力されない。  
新MS-IME の仕様です。
* (新MS-IME) かな入力できなくなったり、入力中のかなが消せなくなることがある  
まず、他のウインドウをマウスで選び、再び元のソフトに切り替えてください。  
それでも直らないときは、ファイルに保存してソフトを一度終了してください。
* (Google 日本語入力) 左右シフト英数に設定していると、左右シフトを離した後の英字がローマ字  
Google 日本語入力 が一時的に英数入力になっていることを検出できないからです。
# 動作確認
* Windows 10 Home version 21H2 64-bit + AutoHotkey (v1.1.34.04) U64 Unicode 64-bit.bin  
新旧MS-IME、ATOK 2017、Google 日本語入力
* Windows 11 Pro version 21H2 + AutoHotkey (v1.1.34.04) U64 Unicode 64-bit.bin  
新MS-IME ── 不具合については上に記した通り  
旧MS-IME ── __かなのローマ字の頭文字だけ出力されるようになっても、Windowsを再起動すると直るようです__
# 参考
* [【薙刀式】v14集大成版](http://oookaworks.seesaa.net/article/484704326.html#gsc.tab=0)
* [【薙刀式】v15候補](http://oookaworks.seesaa.net/article/489739560.html#gsc.tab=0)
## 詳細メニューを出現させるには
設定ファイル Hachiku.ini をエディタで下記のように編集します。そして、Hachiku を再起動してください。
```
[general]
AdvancedMenu=1
```
## src¥KanaTable¥*.ahk で使えるキーや記号の書き方
次の半角文字は書き換えが必要です。
```
0 → {0}
! → {!}
\# → {#}
^ → {^}
+ → {+}
` → ``
{ → {{}
} → {}}
" → ""
```
このほかの文字(全角文字も)はそのまま登録できます。

特殊キーは http://ahkwiki.net/Send のものが使えます。
```
{Enter} {Esc} {Space} {Tab} {BS} {Del} など
```
このほか、
```
{→} {->} {右} {←} {<-} {左} {↑} {上} {↓} {下}
{ペースト} {貼付} {貼り付け} {カット} {切取} {切り取り} {コピー}
{無変換} {変換} {ひらがな} {カタカナ} {改行} {後退} {取消} {削除}
{全角} {タブ} {空白} {メニュー} {Caps Lock} {Back Space}
{確定} {IMEOFF} {IMEON} {全英} {半ｶﾅ} {C_Clr} {C_Bkup} {C_Rstr}
```
などがあります。

ASCIIコード以外の文字や {直接} から後の文字列は、一度 IME をオフにして出力したあと IME を元に戻します。
## 動作速度
* 最初の読み込み
２～３秒程度
* 英数、かなの普通の文字(スペースを除く)
通常 10 ms 以内、エクスプローラー 78 ms 以内。
(ローマ字の文字数によって変わる)
* 記号
最大 0.7秒。
